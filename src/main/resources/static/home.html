<html>
<head>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/activitylook.css"/>
</head>
<body>
<div class="panel-body" style="padding:0px;">
    <div class="panel panel-default">
        <div class="panel-heading">查询条件</div>
        <div class="panel-body">
            <form id="activitylookSearch" class="form-horizontal">
                <div class="form-group" style="margin-top:15px">
                    <div class="col-sm-1">
                    </div>
                    <label class="control-label col-sm-1" for="startDate">开始时间</label>
                    <div class="col-sm-3">
                        <input type="date" class="form-control" id="startDatee">
                    </div>
                    <label class="control-label col-sm-1" for="endDate">结束时间</label>
                    <div class="col-sm-3">
                        <input type="date" class="form-control" id="endDatee">
                    </div>
                    <div class="col-sm-3">
                        <button type="button" style="margin-left:50px" id="activitylookcha" class="btn btn-primary">查询</button>
                        <button type="button" style="margin-left:20px" id="activitylookchong" class="btn btn-danger">重置</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<div id="toolbar" class="btn-group">
    <button id="btn_add" type="button" class="btn btn-default">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
    </button>
    <button id="btn_delete" type="button" class="btn btn-default">
        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
    </button>
</div>
<div style="margin: 0 10px;">
    <table id="tb_activitylook"></table>
</div>
<div style="margin: 0 10px;">
    <table id="tb_activitylookuser"></table>
</div>
<%--添加的modal--%>
<div class="modal fade" id="activitylookaddModal" tabindex="-1" role="dialog" aria-labelledby="activitylookLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title" id="activitylookLabel">新增活动</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" role="form" id="addactivityform">
                    <div class="form-group">
                        <label for="account" class="col-sm-3 control-label">充值金额</label>
                        <div class="col-sm-8">
                            <input type="text"  class="form-control" name="account" id="account"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="freeAccount" class="col-sm-3 control-label">免费送</label>
                        <div class="col-sm-8">
                            <input type="text"  class="form-control" name="freeAccount" id="freeAccount"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="startDate" class="col-sm-3 control-label">起始日期</label>
                        <div class="col-sm-8">
                            <input type="date"  class="form-control" name="startDate" id="startDate"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="endDate" class="col-sm-3 control-label">结束日期</label>
                        <div class="col-sm-8">
                            <input type="date"  class="form-control" name="endDate" id="endDate"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="number" class="col-sm-3 control-label">参与人数</label>
                        <div class="col-sm-8">
                            <input type="text"  class="form-control" name="number" id="number"/>
                        </div>
                    </div>
                </form>
                    <%--充值<input type="text" name="account" id="account"/><br/>--%>
                    <%--送<input type="text" name="freeAccount" id="freeAccount"/><br/>--%>
                    <%--起始时间<input type="date" name="startDate" id="startDate"/><br/>--%>
                    <%--结束时间<input type="date" name="endDate" id="endDate"/><br/>--%>
                    <%--人数<input type="text" name="number" id="number"/><br/>--%>

            </div>
            <%--<button type="button" style="margin-left:50px" id="activitylookadd" class="btn btn-primary">提交</button>--%>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="activitylookadd">提交更改</button>
            </div>
        </div>
    </div>
</div>
<%--查看用户信息的modal--%>
<div class="modal fade" id="rolelookinfoModal" tabindex="-1" role="dialog" aria-labelledby="rolelookinfoLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title" id="rolelookinfoLabel">用户信息</h4>
            </div>
            <div class="modal-body" style="display: flex">
                <%--<span name="pk" id="pk" ></span><br/>--%>
                <%--<span name="idcard" id="idcard"></span><br/>--%>
                <%--<span name="phone" id="phone"></span><br/>--%>
                <%--<span name="password" id="password"></span><br/>--%>
                <%--<span name="name" id="name"></span><br/>--%>
                <%--<span name="age" id="age"></span><br/>--%>
                <%--<span name="gender" id="gender"></span><br/>--%>
                <%--<span name="birthday" id="birthday"></span><br/>--%>
                <%--<textarea cols="30" rows="5" name="signature" id="signature"></textarea><br/>--%>
                <%--<img src="" name="image" id="image" style="width: 120px;height: 200px;"/>--%>
                <div style="flex: 7;">
                    <form class="form-horizontal" role="form" id="edituserform">
                        <input type="hidden" name="pk" id="pk" /><br/>
                        <div class="form-group">
                            <label for="phone" class="col-sm-3 control-label">手机号</label>
                            <div class="col-sm-8">
                                <span  class="form-control" name="phone" id="phone"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="idcard" class="col-sm-3 control-label">身份证号</label>
                            <div class="col-sm-8">
                                <span type="text" class="form-control" name="idcard" id="idcard"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="password" class="col-sm-3 control-label">密码</label>
                            <div class="col-sm-8">
                                <span class="form-control" name="password" id="password"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="name" class="col-sm-3 control-label">姓名</label>
                            <div class="col-sm-8">
                                <span class="form-control" name="name" id="name"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="gender" class="col-sm-3 control-label">性别</label>
                            <div class="col-sm-8">
                                <span name="gender" class="form-control" id="gender"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="age" class="col-sm-3 control-label">年龄</label>
                            <div class="col-sm-8">
                                <span name="age" class="form-control" id="age"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="birthday" class="col-sm-3 control-label">出生年月</label>
                            <div class="col-sm-8">
                                <span  class="form-control" name="birthday" id="birthday"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="signature" class="col-sm-3 control-label">个性签名</label>
                            <div class="col-sm-8">
                                <span class="form-control" name="signature" id="signature"></span>
                            </div>
                        </div>
                    </form>
                </div>
                <div style="flex: 3; margin-top: 22px;">
                    <img src="" name="image" id="image" style="width: 120px;height: 200px;"/>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var currentpk = 1;
    $('#tb_activitylook').bootstrapTable({
        url: 'http://localhost:8073/zboss/activity/look',         //请求后台的URL（*）
        toolbar: '#toolbar',                //工具按钮用哪个容器
        striped: true,                      //是否显示行间隔色
        cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
        pagination: true,                   //是否显示分页（*）
        sortable: true,                     //是否启用排序
        sortOrder: "asc",                   //排序方式
        queryParams: function queryParams (params) {
            var temp = {   //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                page: this.pageNumber,   //页面大小
                size: this.pageSize,  //页码
                sortName:this.sortName,
                sortOrder:this.sortOrder,
                startDate:$("#startDatee").val(),
                endDate:$("#endDatee").val(),
            };
            return temp;
        },//传递参数（*）
        sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
        pageNumber:1,                       //初始化加载第一页，默认第一页
        pageSize: 10,                       //每页的记录行数（*）
        pageList: [10, 15, 20],        //可供选择的每页的行数（*）
        search: true,                       //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以，个人感觉意义不大
        strictSearch: true,
        showColumns: true,                  //是否显示所有的列
        showRefresh: true,                  //是否显示刷新按钮
        minimumCountColumns: 2,             //最少允许的列数
        clickToSelect: false,                //是否启用点击选中行
        height: 508,                        //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
        uniqueId: "pk",                     //每一行的唯一标识，一般为主键列
        showToggle:true,                    //是否显示详细视图和列表视图的切换按钮
        cardView: false,                    //是否显示详细视图
        detailView: false,                   //是否显示父子表
        columns: [{
            align : 'center',
            checkbox: true,
        },{
            field: 'pk',
            title: '序号',
            sortable: true,
        },{
            field: 'activityClassPK',
            title: '类别',
        },{
            field: 'name',
            title: '名字',
            formatter:function(value, row, index){
                return "<img src='http://192.168.25.133/images/meirong/hrrwbd.jpg'>"+
                    "充"+row.account+"送"+row.freeAccount;
            }
        },{
            field: 'account',
            title: '充值金额',
            sortable: true,
            cellStyle:{
                css:{"color":"red"}
            }

        },{
            field: 'freeAccount',
            title: '赠送金额',
            sortable: true,
            cellStyle:{
                css:{"color":"green"}
            }

        },{
            field: 'number',
            title: '人数',
            sortable: true,
        },{
            field: 'alreadyJoinNumber',
            title: '已参加人数',
        },{
            field: 'startDate',
            title: '开始时间',
            formatter:function(value, row, index){
                var date = new Date(value);
                var month = date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1;
                var currentDate = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();
                return date.getFullYear() + "-" + month + "-" + currentDate;
            },
            sortable: true,
        },{
            field: 'endDate',
            title: '结束时间',
            formatter:function(value, row, index){
                var date = new Date(value);
                var month = date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1;
                var currentDate = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();
                return date.getFullYear() + "-" + month + "-" + currentDate;
            },
            sortable: true,
        }, {
            field: 'status',
            title: '状态',
            // formatter:function(value, row, index){
            //     if (value == 1){
            //         return '正常';
            //     }
            // },
        }],
        onClickRow: function (row) {
            currentpk = row.pk;
            $('#tb_activitylookuser').bootstrapTable("refresh");
        }
    });


    $('#tb_activitylookuser').bootstrapTable({
        url: 'http://localhost:8073/zboss/activity/lookactivityuser',         //请求后台的URL（*）
        striped: true,                      //是否显示行间隔色
        cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
        pagination: true,                   //是否显示分页（*）
        sortable: true,                     //是否启用排序
        sortOrder: "desc",                   //排序方式
        queryParams: function queryParams (params) {
            var temp = {   //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                page: this.pageNumber,   //页面大小
                size: this.pageSize,  //页码
                sortName:this.sortName,
                sortOrder:this.sortOrder,
                activitypk:currentpk,
            };
            return temp;
        },//传递参数（*）
        sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
        pageNumber:1,                       //初始化加载第一页，默认第一页
        pageSize: 10,                       //每页的记录行数（*）
        pageList: [10, 15, 20],        //可供选择的每页的行数（*）
        minimumCountColumns: 2,             //最少允许的列数
        height: 500,                        //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
        detailView: false,                   //是否显示父子表
        columns: [{
            field: 'pk',
            title: '序号',
            sortable: true,
        },{
            field: 'name',
            title: '名字',
        },{
            field: 'jobno',
            title: '工号',
            sortable: true,
        },{
            field: 'memberno',
            title: '会员卡号',
            sortable: true,
        },{
            field: 'idcard',
            title: '身份证号',
            sortable: true,
        },{
            field: 'phone',
            title: '手机号',
            sortable: true,
        },{
            field: 'gender',
            title: '性别',
            formatter:function(value, row, index){
                if (value == true)
                    return "<span class='fa fa-male' style='font-size:18px;color:green;'></span>";
                else if (value == false)
                    return "<span class='fa fa-female' style='font-size:18px;color:pink;'></span>";
                else
                    return "-";
            },
        },{
            field: 'birthday',
            title: '出生年月',
            formatter:function(value, row, index){
                var date = new Date(value);
                var month = date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1;
                var currentDate = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();
                return date.getFullYear() + "-" + month + "-" + currentDate;
            },
            sortable: true,
        },{
            field: 'age',
            title: '年龄',
        },{
            field: 'registerDate',
            title: '注册时间',
            formatter:function(value, row, index){
                var date = new Date(value);
                var month = date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1;
                var currentDate = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();
                var hours = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
                var minutes = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
                var seconds = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
                return date.getFullYear() + "-" + month + "-" + currentDate + " " + hours + ":" + minutes + ":" + seconds;
            },
            sortable: true,
        },{
            field: 'signature',
            title: '个性签名',
            formatter:function(value, row, index){
                if(value == null){
                    return "无";
                }else{
                    if (value.length >= 5)
                        return value.substr(0,4)+"...";
                    else
                        return value;
                }
            }
        },{
            field: 'status',
            title: '状态',
        },{
            title: '操作',
            formatter:function(value, row, index){
                return '<div  class="btn btn-primary" ' +
                    'onclick="roleinfolook('+row.pk+',\''+row.idcard+'\''
                    +',\''+row.phone+'\''+',\''+row.password+'\''
                    +',\''+row.name+'\''+','+row.gender+','
                    +row.birthday
                    +',\''+row.image+'\''+',\''+row.signature+'\','+row.age
                    +')" style="font-size:13px;width: 60px;height:25px;padding:0px;line-height: 25px;">详细信息</div>';
            },
        }]
    });
    $("#activitylookchong").click(function(){
        $("#startDatee").val("");
        $("#endDatee").val("");
    });
    $("#activitylookcha").click(function(){
        $('#tb_activitylook').bootstrapTable("refresh");
    });
    //显示添加模态框
    $("#btn_add").click(function(){
        $("#activitylookaddModal").modal("show");
    });
    //添加提交
    $("#activitylookadd").click(function(){
        $('#addactivityform').data('bootstrapValidator').validate();
        if ($("#addactivityform").data("bootstrapValidator").isValid()){
            $.ajax({
                type:'GET',
                dataType:'json',
                url:'http://localhost:8073/zboss/activity/addActivity',
                // contentType:'application/json',
                data:{
                    account:$("#account").val(),
                    freeAccount:$("#freeAccount").val(),
                    startDate:$("#startDate").val(),
                    endDate:$("#endDate").val(),
                    number:$("#number").val(),
                },
                success:function(data){
                    if (data.data == "success"){
                        // alert("新增成功");
                        // $("#activitylookaddModal").modal("hide");
                        // $('#tb_activitylook').bootstrapTable("refresh");
                        window.location.reload();
                    }else{
                        alert("新增失败");
                    }
                },
            });
        };
    });
    //删除按钮
    $("#btn_delete").click(function(){
        if ($('#tb_activitylook').bootstrapTable('getSelections').length == 0){
            alert("请选择要删除的活动");
            return;
        }
        if ($('#tb_activitylook').bootstrapTable('getSelections').length > 0){
            if (confirm("确定要删除这些活动吗")){
                var arr = [];
                for (var i=0; i<$('#tb_activitylook').bootstrapTable('getSelections').length; i++){
                    arr.push($('#tb_activitylook').bootstrapTable('getSelections')[i].pk);
                }
                $.ajax({
                    type:'POST',
                    dataType:'json',
                    contentType:'application/json;charset=utf-8',
                    url:'http://localhost:8073/zboss/activity/remove',
                    data: JSON.stringify(arr),
                    success:function (data){
                        if (data.data == "success"){
                            $('#tb_activitylook').bootstrapTable("refresh");
                        }
                    },
                });
            }
        }

    });

    $("#addactivityform").bootstrapValidator({
        // 默认的提示消息
        message: 'This value is not valid',
        // 表单框里右侧的icon
        feedbackIcons: {
            valid: 'glyphicon glyphicon-ok',
            invalid: 'glyphicon glyphicon-remove',
            validating: 'glyphicon glyphicon-refresh'
        },
        fields: {
            account:{
                validators: {
                    notEmpty: {
                        message: '充值金额不能为空'
                    },
                    digits: {
                        message: '该值只能包含数字'
                    },
                    lessThan: {
                        value: 10000,
                        message: '最大值为10000'
                    }
                }
            },
            freeAccount:{
                validators: {
                    notEmpty: {
                        message: '赠送金额不能为空'
                    },
                    digits: {
                        message: '该值只能包含数字'
                    },
                    lessThan: {
                        value: 10000,
                        message: '最大值为10000'
                    }
                }
            },
            startDate:{
                validators: {
                    notEmpty: {
                        message: '起始日期不能为空'
                    },
                }
            },
            endDate:{
                validators: {
                    notEmpty: {
                        message: '结束日期不能为空'
                    },
                    callback: {
                        message: '开始时间必须小于结束时间',
                        callback: function (value, validator, $field) {
                            var other = validator.getFieldElements('startDate').val();//获得另一个的值
                            var start = new Date(other.replace("-", "/").replace("-", "/"));
                            var end = new Date(value.replace("-", "/").replace("-", "/"));
                            if (start < end) {
                                return true;
                            }
                            return false;
                        }
                    }
                }
            },
            number:{
                validators: {
                    notEmpty: {
                        message: '参与人数不能为空'
                    },
                    digits: {
                        message: '该值只能包含数字'
                    },
                    lessThan: {
                        value: 100,
                        message: '人数最大值为100'
                    },
                    greaterThan: {
                        value: 1,
                        message: '人数最小值为1'
                    },
                }
            },
        }
    });
</script>
</body>
</html>
